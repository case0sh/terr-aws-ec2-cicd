#cloud-config
repo_update: true
repo_upgrade: true
output:
  init:
    output: "> /var/log/cloud-init.out"
    error: "> /var/log/cloud-init.err"
  config: "tee -a /var/log/cloud-config.log"
  final:
    - ">> /var/log/cloud-final.out"
    - "/var/log/cloud-final.err"


groups:
  - docker

packages:
  - nginx
  - neofetch
  - git 
  - httpie 
  - vim 
  - jq 
  - zip 
  - unzip
  - tmux
  - nmap
  - curl
  - wget
  - git
  - vim
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg-agent
  - software-properties-common
runcmd:
  - curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -
  - add-apt-repository "deb [arch=$(dpkg --print-architecture)] https://download.docker.com/linux/debian $(lsb_release -cs) stable"
  - apt-get update -y
  - apt-get install -y docker-ce docker-ce-cli containerd.io
  - systemctl start docker
  - systemctl enable docker
  - usermod -aG docker $USER
  - cd /home/ubuntu/ && git clone git clone https://github.com/PepeCitron/projectzomboid-server.git
  - cd /home/ubuntu/projectzomboid-server && docker compose up -d 
write_files:
  - path: /home/ubuntu/docker-compose.yaml
    content: |
      version: "3.8"
      services:
        project-zomboid:
          container_name: pzserver
          image: pepecitron/projectzomboid-server
          restart: unless-stopped
          environment:
            SERVER_ADMIN_PASSWORD: "pzadmin"
            SERVER_PASSWORD: "secretpassword"
          ports:
            - "8766:8766/udp"
            - "8767:8767/udp"
            - "16261:16261/udp"
          volumes:
            - ./data/server-file:/data/server-file
            - ./data/config:/data/config

final_message: "The system is finally up, after $UPTIME seconds"